<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../baasic-globals/globals-import.html">
<link rel="import" href="../baasic-globals/config.html">
<link rel="import" href="../baasic-globals/baasic-ajax.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-signals/iron-signals.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <baasic-login></baasic-login>

@demo
-->
<dom-module id="baasic-login">

    <style>
        :host {
            display: block;
        }

        /* Logged in */
        .logininfo .message {
            margin-bottom: 20px;
        }

        /* Loginbox */
        .loginform {
            margin-bottom: 20px;
        }
        /* loader by http://projects.lukehaas.me/css-loaders/ */
        .loader {
            display: inline-block;
            font-size: 10px;
            position: relative;
            text-indent: -9999em;
            border-top: 2px solid #00c2e8;
            border-right: 2px solid #00c2e8;
            border-bottom: 2px solid #00c2e8;
            border-left: 2px solid transparent;
            -webkit-animation: load8 1.1s infinite linear;
            animation: load8 1.1s infinite linear;
        }

            .loader,
            .loader:after {
                border-radius: 50%;
                width: 2em;
                height: 2em;
            }

        @-webkit-keyframes load8 {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        @keyframes load8 {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
    </style>

    <template>
        <div id="container">
            <template is="dom-if" if="{{!isLoggedIn}}">
                <div id="loginbox">
                    <div class="[ loginform ]">
                        <paper-input id="txtUsername" label="Username" value="{{username}}" floatinglabel></paper-input>
                        <paper-input id="txtPassword" label="Password" type="password" value="{{password}}" floatinglabel></paper-input>
                    </div>
                    <paper-button on-click="logIn">Log in</paper-button>
                    <template is="dom-if" if="{{loginInProgress}}">
                        <span class="loader">Loading</span>
                    </template>
                </div>
            </template>
            <template is="dom-if" if="{{isLoggedIn}}">
                <div id="loggedin" class="[ logininfo ]">
                    <div class="[ message ]">Welcome <strong>{{baasicUser.userName}}</strong>!</div>
                    <div>
                        <paper-button id="btnClick" on-click="logOut">Log out</paper-button> 
                    </div>
                </div>
            </template>
        </div>

        <iron-signals on-iron-signal-user-login="loginChanged"></iron-signals>
        <paper-toast text="An error has occured while trying to log you in. Please check your data and try again." id="toastError" onclick="discardToast(el)"></paper-toast>
    </template>

</dom-module>

<script>

    Polymer({

        is: 'baasic-login',
        behaviors: [Baasic.Ajax, Baasic.Config],
        properties: {

            redirectUrl: { type: String, value: '', notify:true },
            loginInProgress: { type: Boolean, value: false, notify: true },
            isLoggedIn: { type: Boolean, value: false, notify: true },
            username: { type: String, value: '', notify: true },
            password: { type: String, value: '', notify: true }

        },
        computeLoginUrl: function (baseUrl, version, application) {
            return (baseUrl + '/' + version + "/" + application + '/login?type=Forms');
        },
        baasicUser: {},
        loginUrl: '',
        // Element Lifecycle
        ready: function () {
            this.loginUrl = this.computeLoginUrl(this.baseUrl, this.version, this.application);
            this.loadUser();
        },

        loadUser: function () {
            this.baasicUser = Baasic.Cache.getItem('baasicUser');
            if (!this.baasicUser)
                this.baasicUser = {};
            this.toggleView();
        },
        logIn: function () {
            this.loginInProgress = true;

            Baasic.Ajax.go(this.loginUrl,
                            'POST',
                            'grant_type=password&username=' + this.username + '&password=' + this.password,
                            null,
                            'application/x-www-form-urlencoded')
                        .then(this.postResponse.bind(this))
                        .catch(this.postError.bind(this));
        },
        loginChanged: function (data) {
            if (data.detail && data.detail.baasicUser && !data.detail.baasicUser.accessToken) {
                this.resetUser();
            }
        },
        resetUser: function () {
            this.baasicUser = {};
            Baasic.Cache.removeItem('baasicUser');
            this.toggleView();
        },
        logOut: function () {
            //signal that user has logged out, so other modules could switch views acordingly
            this.fire('iron-signal', { name: 'user-login', data: { baasicUser: {} } });
        },
        postResponse: function (e) {
            this.baasicUser.accessToken = e.access_token;
            this.baasicUser.tokenType = e.token_type;
            this.baasicUser.userName = this.username;
            this.baasicUser.expiresIn = e.expires_in;
            ////before storing the user to the cache, perform an additional GET call on the same login API endpoint to retrieve additional user data - groups, id, etc.
            Baasic.Ajax.go(this.loginUrl,
                            'GET',
                            null,
                            this.baasicUser.tokenType + ' ' + this.baasicUser.accessToken)
                        .then(this.getResponse.bind(this))
                        .catch(this.getError.bind(this));

        },
        postError: function (e) {
            this.loginInProgress = false;
            this.$.toastError.show();
        },
        getResponse: function (e) {
            this.baasicUser.roles = e.roles;
            this.baasicUser.id = e.id;
            this.baasicUser.expiresAbsolute = new Date(new Date().getTime() + (this.baasicUser.expiresIn * 1000));
            this.baasicUser.isAdmin = Baasic.Utils.isArrayMatch(this.adminRoles, e.roles);
            ////now that we have everything, save the user data to the local storage
            Baasic.Cache.setItem('baasicUser', this.baasicUser, {
                expirationAbsolute: this.baasicUser.expiresAbsolute,
                expirationSliding: null,
                priority: Cache.Priority.HIGH,
                callback: null
            });

            ////signal that user has logged in, so other modules could switch views acordingly
            this.fire('iron-signal', { name: 'user-login', data: { baasicUser: this.baasicUser } });
            this.loginInProgress = false;
            ////redirect to another URL if needed
            if (this.redirectUrl)
                window.location.href = this.redirectUrl;
            else
                this.toggleView();

        },
        getError: function (e) {
            this.loginInProgress = false;
            this.$.toastError.show();
        },
        toggleView: function () {
            if (this.baasicUser && this.baasicUser.accessToken)
                this.isLoggedIn = true;
            else
                this.isLoggedIn = false;
        },
        discardToast: function (el) {
            el.dismiss();
        }

    });

</script>
